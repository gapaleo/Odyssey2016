<%= render 'layouts/navbar' %>

<script>
    $(function() {
        showFutureDays();
    });

    function showFutureDays() {
        $('.past-date').hide();
        $('.future-date').show();
    }
    
    function showPastDays() {
        $('.future-date').hide();
        $('.past-date').show();
    }
</script>

<div class='container white-container'>

    <div class="row">
        <%= render 'layouts/flash_messages' %>
        <div class="col-xs-10 col-xs-offset-1">
            <h2>Schedule</h2>
            <p>Select a pickup from the list below to edit. To add a new donation click 'Add New Pickup Day.'</p>
        </div>
    </div>
    <br />
    <div class="row">
        <div class="col-xs-7 col-xs-offset-1">
            <a href="/days/new">
                <btn class="btn btn-success"><span class="glyphicon glyphicon-plus"></span>&nbsp;&nbsp;Add New Pickup Day</btn>
            </a>
        </div>
        <div class="col-xs-3 text-right">
            <strong>View:</strong>
            <select id="view-option">
                <option value="0">Days in the future</option>
                <option value="1">In the past 30 days</option>
            </select>
        </div>
    </div>
    <br />
    <div class="row">
        <div class="col-xs-10 col-xs-offset-1">
            <table class="table table-hover table-striped">
                <thead>
                    <tr>
                        <th></th>
                        <th>Scheduled Date</th>
                        <th class="hidden-xs">Number of Pickups</th>
                        <th class="hidden-xs">Cities</th>
                    </tr>
                </thead>
                <tbody>
                    <% showed_this_week = false %>
                    <% showed_next_week = false %>
                    <% showed_after_next_week = false %>
                    
                    <% @days.each_with_index  do |day, index| %>
                        <tr <% if (day.date < Date.today) %>
                                <%= 'class=past-date' %> 
                            <% else %>
                                <%= 'class=future-date' %>
                            <%end %>
                            style="cursor:pointer;" data-link="<%= days_path %>/<%= day.id %>">
                            
                            <td>
                            <% if index == 0 %>
                                <strong>Past <%= (Date.today - day.date).to_i %> Days</strong>
                            <% elsif is_in_this_week(day.date) && (day.date >= Date.today) && (showed_this_week == false) %>
                                <strong>This Week</strong>
                                <% showed_this_week = true %>
                            <% elsif is_in_next_week(day.date) && (showed_next_week == false) %>
                                <strong>Next Week</strong>
                                <% showed_this_week = true %>
                            <% elsif is_after_next_week(day.date) && (showed_after_next_week == false) %>
                                <strong>Future</strong>
                                <% showed_this_week = true %>
                            <% end %>
                            </td>
                            <td>
                                <% # format the date as Day, Month dd, yyyy %>
                                <%= day.date.strftime('%A, %B %d, %Y') %>
                            </td>
                            <td class="hidden-xs">
                                <%= day.pickups.count %>
                            </td>
                            <td class="hidden-xs">
                                <% # For each day, go trhough all pickups. If there are pickups, %>
                                <% #     loop through and print all the cities for that pickups. %>
                                <% if day.pickups.any? %>
                                    <% day.pickups.each do |p| %>
                                        <%= p.donor_city %>
                                        <% if p != day.pickups.last %>
                                            <% # put a comma inbetween the cities if its not the last pickup %>
                                            <%= ',' %>
                                        <% end %>
                                    <% end %>
                                <% else %>
                                    <% # only show this if no pickups for the given day %>
                                    <small><em>No scheduled pickups</em></small>
                                <% end %>
                            </td>
                        </tr>
                    <% end %>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    $('#view-option').on('change', function() {
      if(this.value == 0){
          showFutureDays();
      }
      else if(this.value == 1){
          showPastDays()
      }
    });
</script>